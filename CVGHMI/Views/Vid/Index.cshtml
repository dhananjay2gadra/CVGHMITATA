@model CVGHMI.Models.LocData
@{
    ViewData["Title"] = "Video";
}
<script>
    var profile_id = '@ViewBag.profile_id';

</script>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdn.bootcss.com/flv.js/1.5.0/flv.min.js" type="text/javascript"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/alawmulaw-master/alawmulaw-master/dist/alawmulaw.js"></script>
<script src="~/lib/vid/voice.js"></script>

<style>
.padding-0 {
padding-right: 0;
padding-left: 0;
border-right: 1px solid #fff;
border-left: 1px solid #fff;
}
#map {
height: 220px;
width: 948px;
box-shadow: rgba(0, 0, 0, 0.05) 0px 6px 24px 0px, rgba(0, 0, 0, 0.08) 0px 0px 0px 1px;
margin-left: -10px;
}
.col {
box-shadow: rgba(0, 0, 0, 0.05) 0px 6px 24px 0px, rgba(0, 0, 0, 0.08) 0px 0px 0px 1px;
}
.speed {
background-color: #fff;
color: #28231D;
font-family: serif;
padding: 0.2rem;
}

@@media (min-width: 600px) and (max-width: 899px) {
#map {
width: 100%;
margin-left: 0;
}
}

 @@media (min-width: 900px) and (max-width: 1199px) {
 #map{
 width: 100%;
 margin-left: 0;
}
}

@@media (min-width: 1200px) {
#map
{
width: 948px;
margin-left: -10px;
}
}
.collapsible li {
    cursor: pointer;
}
.list_of_vehicle {
height: 60vh;
overflow: hidden;
overflow-y: auto;
}
#vehlist {
height: 60vh;
font-size: 11px;
color: #000;
/* overflow-y: scroll; */
}

.list-group-item {
background-color: #ffffff;
border-right: none;
border-left: none;
padding: 5px;
height: 25px;
font-weight: bold;
cursor: pointer;
}

.list-group-flush > .list-group-item {
border-width: 1px 0px 1px;
margin-top: 1px;
}

.sp_item {

}

.btn1 {
margin: 2%;
width: 45px;
height: 26px;
padding: 0%;
color: #ffffff;
background-color: #ACE1AF;
border: 1px solid #17B169;
}

.btn2 {
margin: 2%;
width: 47px;
height: 26px;
padding: 0%;
color: #ffffff;
background-color: #fd5c63;
border: 1px solid #AA0000;
}

#playButton {
margin-left: 0px;
margin-top: 4%;
width: 140px;
height: 80px;
/*  display: none; */
}
</style>

<div class="row">



    @*   side panel list  *@
    <div class="col-lg-2 col-md-4 col-sm-12 col">
        <div class="row">
            <div class="col-lg-12 list_of_vehicle">
                <div class="listcontainer" id="vehlist" style="padding: 6px;border-radius: 10px;">

                    <label for="cars" style="font-weight:bold; text-align: center; width: 100%;">Select Organization</label>

                    <select id="ddlorg" onchange="ddlchange()" style="text-align:center; width:100%;height: 30px; border-radius: 5px; background-color: white; margin-top: 5px; margin-bottom: 5px;">
                        <option value="Select Any One">Select Any One</option>
                        @foreach (var ownerInfo in Model.ownerInfos)
                        {

                            <option value="@ownerInfo.owner_id">@ownerInfo.owner_id</option>

                        }
                    </select>
                    <ul id="vilist" class="list-group list-group-flush">
                    </ul>



                </div>

            </div>

        </div>
        @*   buttons *@
        <div class="row" style="margin-top:6%;text-align:center;">
            <div class="col-lg-12 twoWay">


                <li class="list-group-item" style="padding:1px;color:grey" id="selveh"></li>
                <button type="button" class="btn btn1">Call</button>
                <button type="button" class="btn btn2">Reject</button>

               
                <video id="playButton" style="display: none;"  loop>
                    <source src="~/lib/location/audiovideo.mp4" type="video/mp4">
                </video>
            </div>
        </div>


    </div>
    @*   end side panel list *@









    <div class="col-lg-10">
        <div class="row">
            <div class="col-lg-6 col-md-4 col-sm-12 padding-0 ">
                <div id="xxoo" style="background-color: #000;border-radius: 10px; overflow: hidden; width: 100%; height: 250px;">
                </div>

            </div>
            <div class="col-lg-6 col-md-4 col-sm-12 padding-0 ">
                <div id="xxoo2" style="background-color: #000;border-radius: 10px; overflow: hidden; width: 100%; height: 250px;">
                </div>

            </div>
        </div>
        <div class="row speed">
            <div class="col-lg-12 col">
                <div id="speed"><img src="~/images/speed.png" width="25" height="25" /><span> Speed </span><span id="setSpeed"> 0</span><span>Km/hr </span></div>

            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 col">
                <div id="map"></div>
            </div>
        </div>
    </div>


</div>

@Html.Partial("~/Views/Shared/messageinfo.cshtml")

@Html.Partial("~/Views/Shared/_offlineClient.cshtml")

<script type="text/javascript">

    function FLVPlayer(opts) {

        var videoElement = document.createElement('VIDEO');
        videoElement.autoplay = true;
        videoElement.controls = false;
        videoElement.muted = false;
        videoElement.style.width = '100%';
        videoElement.style.height = '100%';
        opts.container.append(videoElement);

        this.container = opts.container;
        this.videoElement = videoElement;
        this.httpFlvURL = opts.url;

        this.mediaInfo = null;
        this.play = null;
        this.onPlayEvtListener = null;
        this.onPauseEvtListener = null;
        this.onStopEvtListener = null;

        this.autoFastForward = opts.autoFastForward;
        this.autoFastForwardInterval = null;

        this.play = function () {
            if (this.player) return;

            var self = this;
            self.player = new flvjs.createPlayer({
                type: 'flv',
                url: self.httpFlvURL,
                isLive: true,
                enableWorker: true,
                enableStashBuffer: true,
                autoCleanupSourceBuffer: true,
                autoCleanupMaxBackwardDuration: 5,
                autoCleanupMinBackwardDuration: 1
            });

            self.player.on('media_info', function () {
                self.mediaInfo = self.player.mediaInfo;
            });

            self.player.on('statistics_info', function () {
                console.log(arguments);
            });

            var autoPlayTimer = null;
            self.videoElement.addEventListener('player', function (e) {
                if (autoPlayTimer) clearInterval(autoPlayTimer);
                if (self.onPlayEvtListener) self.onPlayEvtListener(self, e);
            });
            self.videoElement.addEventListener('dblclick', function () {
                if (self.videoElement.requestFullscreen) self.videoElement.requestFullscreen();
            });
            autoPlayTimer = setInterval(function () {
                try { self.player.play(); } catch (e) { clearInterval(autoPlayTimer); };
            });

            self.player.attachMediaElement(self.videoElement);
            self.player.load();
            self.player.play();

            if (this.autoFastForward) this.autoFastForwardInterval = setInterval(function () {
                if (self.videoElement.buffered.length > 0 && self.videoElement.buffered.end(0) - self.videoElement.currentTime > 2) {
                    console.log(self.videoElement.buffered.end(0) + "-" + self.videoElement.currentTime);
                    self.videoElement.currentTime = self.videoElement.buffered.end(0) - 1;
                }
            }, 1000);
        };

        this.fullscreen = function () {
            if (this.videoElement && this.videoElement.requestFullscreen)
                this.videoElement.requestFullscreen();
        };

        this.onPlay = function (fn) {
            this.onPlayEvtListener = fn;
        };

        this.destroy = function () {
            this.player.destroy();
            clearInterval(this.autoFastForwardInterval);
        }
    }
</script>
<script type="text/javascript">
    if (location.hash) {
        var hash = location.hash.substring(1);
        $('#tag').val(hash);
    }

    var videoPlayerone = null;
    function playVideo(videoUrl) {
        $('#xxoo').empty();
        if (videoPlayerone != null)
            videoPlayerone.destroy();
        videoPlayerone = new FLVPlayer({
            container: $('#xxoo'),
            url: videoUrl,

            autoFastForward: false
        });
        videoPlayerone.play();

    }
    function playVideo2(videoUrl) {
        var videoPlayer = new FLVPlayer({
            container: $('#xxoo2'),
            url: videoUrl,

            autoFastForward: false
        });
        videoPlayer.play();
    }
</script>
<script>
    //Video Request For Start Streaming 1

    function makevideoStartRequest(device_id) {
        var url = 'Data/VideoStart';

        var requestData = { cid: String(device_id), channel: 1 };
        $.ajax({
            url: url,
            type: 'POST',
            async: "false",
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                //console.log('POST request successful');
                //console.log(response);
                //window.open('Video?VideoId=' + device_id + '-2');
                //playVideo('http://103.30.118.143:6602/video/' + device_id + '-1');
                //alert(response.msg);
                if (response.success == true) {

                    playVideo('https://dfmsmi.corp.tatasteel.com/video/' + device_id + '-1');
                    // alert("yes");

                }
                else {
                    //alert("false");
                    $('#infoOfflineClient').modal('show');

                }

            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });

    }
    //Video Request For End Streaming 1
    function makevideoEndRequest(device_id) {
        var url = 'Data/VideoEnd';

        var requestData = { cid: String(device_id), channel: 1 };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                console.log('POST request successful');
                console.log(response);
                //  makevideoStartRequest(data);

            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });

    }


    //Video Request For Start Streaming 2
    function makevideoStartRequest2(device_id) {



        var url = 'Data/VideoStart';

        var requestData = { cid: String(device_id), channel: 2 };
        $.ajax({
            url: url,
            type: 'POST',
            async: "false",
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                //console.log('POST request successful');
                //console.log(response);
                //window.open('Video?VideoId=' + device_id + '-2');
                playVideo2('http://103.30.118.143:6602/video/' + device_id + '-2');
            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });

    }
    //Video Request For End Streaming 2
    function makevideoEndRequest2(device_id) {
        var url = 'Data/VideoEnd';

        var requestData = { cid: String(device_id), channel: 2 };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                console.log('POST request successful');
                console.log(response);
                // makevideoStartRequest2(data);
            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });
    }

    //video call method on button click
    function vid(data) {
        // alert(data);
        makevideoEndRequest(data);
        // makevideoEndRequest2(data)
        wait(1000);
        makevideoStartRequest(data);
        // makevideoStartRequest2(data);
        // http://103.30.118.143:6602/video/791074553303-2




    }

    function wait(timeout) {
        return new Promise(resolve => {
            setTimeout(resolve, timeout);
        });
    }
</script>

<script>

    function makecallRequest(device_id) {
        var url = 'Data/Call';
        //var objdata = `{"cid":"${device_id}"}`;
        //var requestData = { "cid": device_id };
        var selve = $('#selveh').text();
        var requestData = { cid: String(device_id) };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                console.log('POST request successful');
                console.log(response.code);
                if(response.code==200)
                {
                    var video = document.getElementById("playButton");
        video.style.display = "block";  // First, show the video
       video.play();  // Then, play the video
                 playButton.disabled = true;  // Disable the Play button
                 startWebSocket();
                }
                else
                {
                    alert("Currentlly device "+selve+" which imei no "+device_id+" is in low network zone or is on an another call. Please try again later after sometime ");
                }
                // Handle the response here
            },
            error: function (xhr, status, error) {
                alert('POST request failed');
                // Handle errors here
            }
        });
    }


    function makecallEndRequest(device_id) {
        var url = 'Data/CallEnd';

        var requestData = { cid: String(device_id) };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                if(response.code==200)
                {
                     var video = document.getElementById("playButton");
        video.style.display = "none";  // Hide the video

        stopWebSocket();

                }
                else
                {
                     var video = document.getElementById("playButton");
                     video.style.display = "none";  // Hide the video
                     stopWebSocket();
                     alert(response.msg);
                }
                console.log('POST end request successful');
                console.log(response);
                console.log(response.code);

            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });

    }

    var str_array = '@Model.profile.profile_location';
    var st = str_array.split(',');
    var profile_id = '@Model.profile.profile_id';
    //alert(st[0]);

    const map = L.map('map').setView([st[0], st[1]], @Model.profile.profile_zoom_level);




    // Satellite Layer
    const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '&copy; <a href="http://www.machindia.com">MACHINDIA</a>'
    }).addTo(map);

    // Street Layer
    const streetLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '&copy; <a href="http://www.machindia.com">MACHINDIA</a>'
    });

    // Layer control
    const baseMaps = {
        "Satellite": satelliteLayer,
        "Street": streetLayer
    };

    L.control.layers(baseMaps).addTo(map)

    var clidText;
    var flag = false;

    // Function to handle changes in the dropdown
    function ddlchange() {
        var dldata = $('#ddlorg').val();
        setlist(dldata);
    }

    // Set initial dropdown selection if applicable
    if ($('#ddlorg option').length > 1) {
        setlist($('#ddlorg option:eq(1)').val());
        $('#ddlorg').prop('selectedIndex', 1);
    }

    // Function to fetch and display devices based on selected organization
    function setlist(dldata) {
        $.ajax({
            url: 'Data/GetDevice/' + dldata,
            type: 'GET',
            success: function (data) {
                var vilist = $('#vilist');
                vilist.empty(); // Clear existing data

                var lidata = data.map(item =>
                    `<li class="list-group-item card"><span class="sp_item" data-clientid="${item.clientid}" onclick="handleListItemClick(this)">${item.plate_no}</span></li>`
                ).join('');

                vilist.html(lidata);
                attachClickEvents(vilist);
            },
            error: function (xhr, status, error) {
                console.error('Error fetching devices:', error);
            }
        });
    }

    var chveh;

    function checkVehicle() {
        $.ajax({
            url: 'data/GetDeviceSession',
            method: 'GET',
            success: function (data) {
                const items = document.querySelectorAll('.sp_item');


                items.forEach(item => {
                    item.style.color = '#fd5c63';
                });


                data.forEach(vehicle => {
                   
                    var plateNo;
                    if (vehicle.attributes.device == null) {
                        plateNo = "";
                    }
                    else {
                        plateNo = vehicle.attributes.device.plateNo;
                    }
                    
                    


                    items.forEach(item => {
                        if (item.textContent.trim() === plateNo) {
                            item.style.color = '#17B169';
                        }
                    });
                });
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', status, error);
            }
        });
    }

    chveh = setInterval(checkVehicle, 3000);
    // // Function to attach click events to vehicle items
     function attachClickEvents(vilist) {
         vilist.find('.sp_item').click(function () {
             if (flag) {
                 $('#infobody').text("Someone already initiated calling, first stop the calling");
               $('#infoLog').modal('show');
            } else {
              clidText = $(this).data('clientid');
                $('#selveh').text($(this).text().trim()); // Set selected vehicle text
             }
         });
     }


    // Prevent double-click from triggering full-screen or other behaviors
    document.getElementById('playButton').addEventListener('dblclick', function (event) {
        event.preventDefault();  // Prevent default double-click behavior
    });

    // Prevent context menu from appearing (right-click)
    document.getElementById('playButton').addEventListener('contextmenu', function (event) {
        event.preventDefault();  // Prevent the context menu from showing up
    });


    // Button event handlers
    var btn1 = document.querySelector(".btn1");
    var btn2 = document.querySelector(".btn2");

    // Call button event
    btn1.addEventListener("click", function () {
        var selve = $('#selveh').text();


       // var video = document.getElementById("playButton");
        //video.style.display = "block";  // First, show the video
       //video.play();  // Then, play the video
       
        makecallRequest(clidText);

        //alert(clidText);

       // var video = document.getElementById("playButton");
        //video.style.display = "none";  // This hides the video
        // if (!selve) {
        //     $('#infobody').text("Please select a vehicle plate before calling");
        //     $('#infoLog').modal('show');
        // } else if (flag) {
        //     $('#infobody').text("Calling is already started");
        //     $('#infoLog').modal('show');
        // } else {
        //     flag = true;
        //     makecallRequest(clidText);
        //     startStreaming();
        //     startRecording();
        //     document.getElementById("playButton").style.display = "block"; // Play audio
        //     document.getElementById("playButton").play();
        // }
    });

    // Reject button event
    btn2.addEventListener("click", function () {
        var selve = $('#selveh').text();

       
        makecallEndRequest(clidText);
        // if (!selve) {
        //     $('#infobody').text("Plate number is not selected, please select one");
        //     $('#infoLog').modal('show');
        // } else if (!flag) {
        //     $('#infobody').text("Reject has already been pressed");
        //     $('#infoLog').modal('show');
        // } else {
        //     flag = false;
        //     document.getElementById("playButton").style.display = "none"; // Pause audio
        //     document.getElementById("playButton").pause();
        //     makecallEndRequest(clidText);
        //     stopRecording();
        //     stopStreaming();
        // }
    });

    var _marinfo = {};
    var latlngs = []; // Global array to store polyline coordinates
    var polyline; // Variable to hold the polyline

    function load_marker(element) {
        // Clear existing markers
        for (var key in _marinfo) {
            if (_marinfo.hasOwnProperty(key)) {
                map.removeLayer(_marinfo[key]);
            }
        }
        _marinfo = {};
        latlngs = []; // Reset the latlngs array

        var apiUrl = `Data/GetGps/${encodeURIComponent(profile_id)}`;
        fetch(apiUrl)
            .then(response => response.json())
            .then(obj => {
                const plateno = element.textContent || element.innerText;
                obj.forEach(data => {
                    if (data.plate_no === plateno) {
                        var myIcon = L.icon({
                            iconUrl: 'images/truck-green.png',
                            iconSize: [44, 24]
                        });

                        // Add the coordinates to the latlngs array
                        const latlng = [data.lat / 1000000.0, data.lng / 1000000.0];
                        latlngs.push(latlng);

                        var marker = L.marker(latlng, { icon: myIcon }).addTo(map);
                        _marinfo[data.plate_no] = marker;

                        // Draw polyline if it doesn’t exist
                        if (!polyline) {
                            polyline = L.polyline(latlngs, {
                                color: 'red',
                                weight: 3,
                                opacity: 0.5,
                                smoothFactor: 1
                            }).addTo(map);
                        } else {
                            // Update polyline coordinates
                            polyline.setLatLngs(latlngs);
                        }

                        marker.bindPopup(data.plate_no, { className: 'custom-tooltip', autoClose: false }).openPopup();
                    }
                });
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function move_marker() {
        var apiUrl = `Data/GetGps/${encodeURIComponent(profile_id)}`;
        fetch(apiUrl)
            .then(response => response.json())
            .then(obj => {
                obj.forEach(data => {
                    if (data.plate_no === marker_plateno) {
                        const newLatLng = new L.LatLng(data.lat / 1000000.0, data.lng / 1000000.0);
                        document.getElementById("setSpeed").innerText = parseFloat(data.speed) / 10;

                        // Update marker position
                        var marker = _marinfo[marker_plateno];
                        if (marker) {
                            marker.setLatLng(newLatLng);
                        }

                        // Update latlngs array and polyline
                        latlngs.push(newLatLng);
                        polyline.setLatLngs(latlngs); // Update polyline with new coordinates

                        // Optionally fit map to bounds
                        map.fitBounds(polyline.getBounds());

                        marker.getPopup().setContent(`${data.plate_no}<br>${data.log_time}`).update();
                    }
                });
            })
            .catch(error => console.error('Error fetching data:', error));
    }



</script>

<script>
    // var chveh;

    // function checkVehicle() {
    //     $.ajax({
    //         url: 'data/GetDeviceSession',
    //         method: 'GET',
    //         success: function (data) {
    //             const items = document.querySelectorAll('.sp_item');


    //             items.forEach(item => {
    //                 item.style.color = '#fd5c63';
    //             });


    //             data.forEach(vehicle => {
    //                 var plateNo = vehicle.attributes.device.plateNo.trim();


    //                 items.forEach(item => {
    //                     if (item.textContent.trim() === plateNo) {
    //                         item.style.color = '#17B169';
    //                     }
    //                 });
    //             });
    //         },
    //         error: function (xhr, status, error) {
    //             console.error('AJAX Error:', status, error);
    //         }
    //     });
    // }

    // chveh = setInterval(checkVehicle, 3000);
    var marker_plateno = "";
    var Interval_marker = null;
    var clientId = "";
    function handleListItemClick(element) {


         clientId = element.getAttribute('data-clientid');
        
        
       ////  marker_plateno = element.textContent || element.innerText;
        // Added quotes to the string
        // Optionally stop the video element if it's defined
        // if (videoElement != null) {
        //     videoElement.stop();
        // }

        // Call both functions
       //// if (Interval_marker != null) {
          ////  clearInterval(Interval_marker);
       //// }
       //// load_marker(element);
        


       //// Interval_marker = setInterval(move_marker, 3000);

        // Call the video function with clientId
       //// vid(clientId);
    }

    $('.leaflet-control-attribution').remove();

</script>

