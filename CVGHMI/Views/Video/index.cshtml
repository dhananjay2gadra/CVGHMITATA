@model CVGHMI.Models.LocData
@{
    ViewData["Title"] = "Video";
}
<script>
    var profile_id = '@ViewBag.profile_id';

</script>



<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdn.bootcss.com/flv.js/1.5.0/flv.min.js" type="text/javascript"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  .padding-0 {
  padding-right: 0;
  padding-left: 0;
  border-right: 1px solid #fff;
  border-left: 1px solid #fff;
}

#map {
  height: 220px;
  width: 948px;
  box-shadow: rgba(0, 0, 0, 0.05) 0px 6px 24px 0px, rgba(0, 0, 0, 0.08) 0px 0px 0px 1px;
  margin-left: -10px;
}

.col {
  box-shadow: rgba(0, 0, 0, 0.05) 0px 6px 24px 0px, rgba(0, 0, 0, 0.08) 0px 0px 0px 1px;
}

.speed {
  background-color: #fff;
  color: #28231D;
  font-family: serif;
  padding: 0.2rem;
}

@@media (min-width: 600px) and (max-width: 899px) {
  #map {
    width: 100%;
    margin-left: 0;
  }
}

@@media (min-width: 900px) and (max-width: 1199px) {
  #map {
    width: 100%;
    margin-left: 0;
  }
}

@@media (min-width: 1200px) {
  #map {
    width: 948px;
    margin-left: -10px;
  }
}

.tree {
  margin: 20px;
}

.tree ul {
  list-style-type: none;
  padding-left: 20px;
  margin: 0;
  position: relative;
}

.tree .folder {
  cursor: pointer;
  display: inline-block;
  margin-left: 5px;
}

.tree .toggle {
  cursor: pointer;
  display: inline-block;
  margin-right: 5px;
  font-weight: bold;
  height: 18px;
  width: 18px;
  text-align: center;
  border: 1px solid #ccc;
  border-radius: 1px;
}

.tree .toggle:hover {
  background-color: #f0f0f0;
}

.tree .collapsible {
  display: none;
  padding-left: 20px;
}

.tree .collapsible.show {
  display: block;
}

.tree ul ul {
  padding-left: 20px;
}

.tree li {
  position: relative;
  padding-left: 20px;
}

.collapsible li {
  cursor: pointer;
}

.ml {
  margin-left: -3em;
  margin-bottom: 0.1em;
  color: #28231D;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 11px;
  font-weight: 600;
}

.tree li::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  border-left: 1px dotted #ccc;
  height: 100%;
  width: 0;
  margin-left: 10px;
}

.tree li::after {
  content: '';
  position: absolute;
  left: 0;
  top: 1em;
  width: 10px;
  height: 0;
  border-top: 1px dotted #ccc;
}

.tree li:last-child::before {
  border-bottom: none;
}

.tree li:first-child::after {
  border-top: none;
}

.list_of_vehicle {
  height: 70vh;
  overflow: hidden;
  overflow-y: auto;
}

.twoWay {
  width: 100%;
  height: 0;
  margin-bottom: 0%;
  padding: 5px;
  margin-left: 1.3rem;
}

.btn1 {
  margin: 2%;
  width: 60px;
  height: 30px;
  padding: 0%;
  color: #ffffff;
  background-color: #ACE1AF;
  border: 1px solid #17B169;
}

.btn2 {
  margin: 2%;
  width: 60px;
  height: 30px;
  padding: 0%;
  color: #ffffff;
  background-color: #fd5c63;
  border: 1px solid #AA0000;
}


</style>

<div class="row">



    @*   side panel list  *@
    <div class="col-lg-2 col-md-4 col-sm-12 col">
        <div class="row">
            <div class="col-lg-12 list_of_vehicle">

                <div class="tree">
                    <ul>

                        @foreach (var ownerInfo in Model.ownerInfos)
                        {

                            <li class="ml">
                                <span class="toggle" onclick="setlist(this)">+</span>
                                @*   <span class="toggle">+</span> *@
                                <span class="folder">@ownerInfo.owner_id</span>
                                <ul class="collapsible" id="@ownerInfo.owner_id">
                                    @*   <li onclick=" load_marker(this)">02K005</li> *@


                                </ul>
                            </li>
                        }

                    </ul>
                </div>
            </div>

        </div>
        
        <div class="row">
            <div class="col-lg-12 twoWay">
                <button type="button" class="btn btn1" onclick="voiceCall()">Call</button>
                <button type="button" class="btn btn2" onclick="voiceEnd()">Reject</button>

            </div>
        </div>


    </div>
    <div class="col-lg-10">
        <div class="row">
            <div class="col-lg-6 col-md-4 col-sm-12 padding-0 ">
                <div id="xxoo" style="background-color: #000;border-radius: 10px; overflow: hidden; width: 100%; height: 250px;">
                </div>

            </div>
            <div class="col-lg-6 col-md-4 col-sm-12 padding-0 ">
                <div id="xxoo2" style="background-color: #000;border-radius: 10px; overflow: hidden; width: 100%; height: 250px;">
                </div>

            </div>
        </div>
        <div class="row speed">
            <div class="col-lg-12 col">
                <div id="speed"><img src="~/images/speed.png" width="25" height="25" /><span> Speed </span><span id="setSpeed"> 0</span><span>Km/hr </span></div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 col">
                <div id="map"></div>
            </div>
        </div>
    </div>


</div>


@Html.Partial("~/Views/Shared/_offlineClient.cshtml")

<script type="text/javascript">

    function FLVPlayer(opts) {

        var videoElement = document.createElement('VIDEO');
        videoElement.autoplay = true;
        videoElement.controls = false;
        videoElement.muted = false;
        videoElement.style.width = '100%';
        videoElement.style.height = '100%';
        opts.container.append(videoElement);

        this.container = opts.container;
        this.videoElement = videoElement;
        this.httpFlvURL = opts.url;

        this.mediaInfo = null;
        this.play = null;
        this.onPlayEvtListener = null;
        this.onPauseEvtListener = null;
        this.onStopEvtListener = null;

        this.autoFastForward = opts.autoFastForward;
        this.autoFastForwardInterval = null;

        this.play = function () {
            if (this.player) return;

            var self = this;
            self.player = new flvjs.createPlayer({
                type: 'flv',
                url: self.httpFlvURL,
                isLive: true,
                enableWorker: true,
                enableStashBuffer: true,
                autoCleanupSourceBuffer: true,
                autoCleanupMaxBackwardDuration: 5,
                autoCleanupMinBackwardDuration: 1
            });

            self.player.on('media_info', function () {
                self.mediaInfo = self.player.mediaInfo;
            });

            self.player.on('statistics_info', function () {
                console.log(arguments);
            });

            var autoPlayTimer = null;
            self.videoElement.addEventListener('player', function (e) {
                if (autoPlayTimer) clearInterval(autoPlayTimer);
                if (self.onPlayEvtListener) self.onPlayEvtListener(self, e);
            });
            self.videoElement.addEventListener('dblclick', function () {
                if (self.videoElement.requestFullscreen) self.videoElement.requestFullscreen();
            });
            autoPlayTimer = setInterval(function () {
                try { self.player.play(); } catch (e) { clearInterval(autoPlayTimer); };
            });

            self.player.attachMediaElement(self.videoElement);
            self.player.load();
            self.player.play();

            if (this.autoFastForward) this.autoFastForwardInterval = setInterval(function () {
                if (self.videoElement.buffered.length > 0 && self.videoElement.buffered.end(0) - self.videoElement.currentTime > 2) {
                    console.log(self.videoElement.buffered.end(0) + "-" + self.videoElement.currentTime);
                    self.videoElement.currentTime = self.videoElement.buffered.end(0) - 1;
                }
            }, 1000);
        };

        this.fullscreen = function () {
            if (this.videoElement && this.videoElement.requestFullscreen)
                this.videoElement.requestFullscreen();
        };

        this.onPlay = function (fn) {
            this.onPlayEvtListener = fn;
        };

        this.destroy = function () {
            this.player.destroy();
            clearInterval(this.autoFastForwardInterval);
        }
    }
</script>
<script type="text/javascript">
    if (location.hash) {
        var hash = location.hash.substring(1);
        $('#tag').val(hash);
    }

    var videoPlayerone = null;
    function playVideo(videoUrl) {
        $('#xxoo').empty();
        if (videoPlayerone != null)
            videoPlayerone.destroy();
        videoPlayerone = new FLVPlayer({
            container: $('#xxoo'),
            url: videoUrl,

            autoFastForward: false
        });
        videoPlayerone.play();

    }
    function playVideo2(videoUrl) {
        var videoPlayer = new FLVPlayer({
            container: $('#xxoo2'),
            url: videoUrl,

            autoFastForward: false
        });
        videoPlayer.play();
    }
</script>
<script>
    //Video Request For Start Streaming 1

    function makevideoStartRequest(device_id) {
        var url = 'Data/VideoStart';

        var requestData = { cid: String(device_id), channel: 1 };
        $.ajax({
            url: url,
            type: 'POST',
            async: "false",
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
               
                if (response.success == true) {

                    playVideo('https://dfmsmi.corp.tatasteel.com/video/' + device_id + '-1');
                    // alert("yes");

                }
                else {
                    //alert("false");
                    $('#infoOfflineClient').modal('show');

                }

            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });

    }
    //Video Request For End Streaming 1
    function makevideoEndRequest(device_id) {
        var url = 'Data/VideoEnd';

        var requestData = { cid: String(device_id), channel: 1 };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {

                if (response.success == true) 
                {
                    makevideoStartRequest(device_id);
                }
                else {
                    //alert("false");
                    $('#infoOfflineClient').modal('show');

                }
                console.log('POST request successful');
                console.log(response);
                //alert(response);
                //  makevideoStartRequest(data);

            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });

    }

    //Video Request For Start Streaming 2
    function makevideoStartRequest2(device_id) {
        var url = 'Data/VideoStart';

        var requestData = { cid: String(device_id), channel: 2 };
        $.ajax({
            url: url,
            type: 'POST',
            async: "false",
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
               
                playVideo2('http://103.30.118.143:6602/video/' + device_id + '-2');
            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });

    }
    //Video Request For End Streaming 2
    function makevideoEndRequest2(device_id) {
        var url = 'Data/VideoEnd';

        var requestData = { cid: String(device_id), channel: 2 };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                console.log('POST request successful');
                console.log(response);
                // makevideoStartRequest2(data);
            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });
    }

    //video call method on button click
    function vid(data) {
        // alert(data);
        makevideoEndRequest(data);
        
        // http://103.30.118.143:6602/video/791074553303-2

    }

    function wait(timeout) {
        return new Promise(resolve => {
            setTimeout(resolve, timeout);
        });
    }


    function voiceCall() 
    {
        makecallRequest(clientId);
        // alert(clientId);
    }

    function voiceEnd() {
        //alert(clientId);

        makecallEndRequest(clientId);
    }
</script>
<script>
    var str_array = '@Model.profile.profile_location';
    var st = str_array.split(',');
    var profile_id = '@Model.profile.profile_id';
    //alert(st[0]);

    const map = L.map('map').setView([st[0], st[1]], @Model.profile.profile_zoom_level);

    // Satellite Layer
    const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '&copy; <a href="http://www.machindia.com">MACHINDIA</a>'
    }).addTo(map);

    // Street Layer
    const streetLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '&copy; <a href="http://www.machindia.com">MACHINDIA</a>'
    });

    // Layer control
    const baseMaps = {
        "Satellite": satelliteLayer,
        "Street": streetLayer
    };

    L.control.layers(baseMaps).addTo(map)

    function setlist(element) {

        var liElement = element.closest('li');
        var folderSpan = liElement.querySelector('.folder');
        var folderText = folderSpan.textContent || folderSpan.innerText;

        $.ajax({
            url: 'Data/GetDevice/' + folderText,
            type: 'GET',
            success: function (data) {

                var vilist = $('#' + folderText);
                vilist.empty();

                var lidata = "";
                data.forEach(function (item) {
                  
                    lidata = lidata + `<li data-clientid="${item.clientid}" onclick="handleListItemClick(this)">${item.plate_no}</li>`;

                });

                vilist.html(lidata);

            },
            error: function (xhr, status, error) {
               
            }
        });


    }
 
    var _marinfo = {};
     var latlngs = []; // Global array to store polyline coordinates
     var polyline; // Variable to hold the polyline

     function load_marker(element) {
         // Clear existing markers
         for (var key in _marinfo) {
             if (_marinfo.hasOwnProperty(key)) {
                 map.removeLayer(_marinfo[key]);
             }
         }
         _marinfo = {};
         latlngs = []; // Reset the latlngs array

         var apiUrl = `Data/GetGps/${encodeURIComponent(profile_id)}`;
         fetch(apiUrl)
             .then(response => response.json())
             .then(obj => {
                 const plateno = element.textContent || element.innerText;
                 obj.forEach(data => {
                     if (data.plate_no === plateno) {
                         var myIcon = L.icon({
                             iconUrl: 'images/truck-green.png',
                             iconSize: [44, 24]
                         });

                         // Add the coordinates to the latlngs array
                         const latlng = [data.lat / 1000000.0, data.lng / 1000000.0];
                         latlngs.push(latlng);

                         var marker = L.marker(latlng, { icon: myIcon }).addTo(map);
                         _marinfo[data.plate_no] = marker;

                         // Draw polyline if it doesn’t exist
                         if (!polyline) {
                             polyline = L.polyline(latlngs, {
                                 color: 'red',
                                 weight: 3,
                                 opacity: 0.5,
                                 smoothFactor: 1
                             }).addTo(map);
                         } else {
                             // Update polyline coordinates
                             polyline.setLatLngs(latlngs);
                         }

                         marker.bindPopup(data.plate_no, { className: 'custom-tooltip', autoClose: false }).openPopup();
                     }
                 });
             })
             .catch(error => console.error('Error fetching data:', error));
     }

     function move_marker() {
         var apiUrl = `Data/GetGps/${encodeURIComponent(profile_id)}`;
         fetch(apiUrl)
             .then(response => response.json())
             .then(obj => {
                 obj.forEach(data => {
                     if (data.plate_no === marker_plateno) {
                         const newLatLng = new L.LatLng(data.lat / 1000000.0, data.lng / 1000000.0);
                         document.getElementById("setSpeed").innerText = parseFloat(data.speed)/10;

                         // Update marker position
                         var marker = _marinfo[marker_plateno];
                         if (marker) {
                             marker.setLatLng(newLatLng);
                         }

                         // Update latlngs array and polyline
                         latlngs.push(newLatLng);
                         polyline.setLatLngs(latlngs); // Update polyline with new coordinates

                         // Optionally fit map to bounds
                         map.fitBounds(polyline.getBounds());

                         marker.getPopup().setContent(`${data.plate_no}<br>${data.log_time}`).update();
                     }
                 });
             })
             .catch(error => console.error('Error fetching data:', error));
     }

</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const toggles = document.querySelectorAll('.toggle');

        toggles.forEach(toggle => {
            toggle.addEventListener('click', () => {
                const collapsible = toggle.nextElementSibling.nextElementSibling;
                if (collapsible.classList.contains('show')) {
                    collapsible.classList.remove('show');
                    toggle.textContent = '+';
                } else {
                    collapsible.classList.add('show');
                    toggle.textContent = '-';
                }
            });
        });
    });
</script>
<script>
    var chveh;

    function checkVehicle() {

        $.ajax({
            url: 'data/GetDeviceSession',
            method: 'GET',
            success: function (Data) {

                const items = document.querySelectorAll('.collapsible li');

                // Loop through each item and apply the style
                items.forEach(item => {
                    item.style.color = 'grey';
                });


                // Iterate through the data array
                for (var i = 0; i < Data.length; i++) {
                    var plate_no = Data[i].attributes.device.plateNo;
                    console.log(plate_no);
                    // Select all items in the list

                    var listItems = document.querySelectorAll('.collapsible li');

                    // Update styles based on the plate_no
                    listItems.forEach(function (item) {
                        if (item.textContent.trim() === plate_no) {
                            item.style.color = 'green';
                        }
                       
                    });
                }

            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', status, error);
            }
        });
    }
   // chveh = setInterval(checkVehicle, 3000);

    var marker_plateno = "";
    var Interval_marker = null;
    var clientId = "";
    function handleListItemClick(element) {
        clientId = element.getAttribute('data-clientid');
        marker_plateno = element.textContent || element.innerText;
        load_marker(element);
        if (Interval_marker != null) {
            clearInterval(Interval_marker);
        }

       // Interval_marker = setInterval(move_marker, 3000);

        vid(clientId);
    }

    $('.leaflet-control-attribution').remove();

    function makecallRequest(device_id) {
        var url = 'Data/Call';
        var requestData = { cid: String(device_id) };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                console.log('POST request successful');
                console.log(response);
                // Handle the response here
            },
            error: function (xhr, status, error) {
                console.error('POST request failed');
                // Handle errors here
            }
        });
    }

    function makecallEndRequest(device_id) {
        var url = 'Data/CallEnd';

        var requestData = { cid: String(device_id) };
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',

            success: function (response) {
                console.log('POST request successful');
                console.log(response);

            },
            error: function (xhr, status, error) {
                console.error('POST request failed');

            }
        });
    }
</script>